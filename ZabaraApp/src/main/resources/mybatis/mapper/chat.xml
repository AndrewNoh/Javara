<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mybatis.mapper.chat">

<resultMap id="chatDtoResult" type="ChatDTO">
<!-- property:자바빈(OneMemoDTO)의 속성명 column:테이블의 컬럼(조회(SELECT)결과의 컬럼명들 의미) -->
<result column="userno" property="userno"/>
<result column="email" property="email"/>
<result column="phonenumber" property="phonenumber"/>
<result column="name" property="name"/>
<result column="password" property="password"/>
<result column="adress" property="adress"/>
<result column="nickname" property="nickname"/>
<result column="wirteuserno" property="wirteuserno"/>
<result column="room_no" property="roomno"/>
<result column="chatcontent" property="chatcontent"/>
<result column="sendtime" property="sendtime"/>
<result column="senduserno" property="senduserno"/>
<result column="unread_count" property="unread_count"/>
<result column="writeusernickname" property="writeusernickname"/>
<result column="no" property="no"/>
<!-- 1:N관계 매핑용 column: 조인조건의 컬럼명 (ON onememo.no = linecomments.no)select: select태그의 id 속성값(쿼리문은 조인문)javaType : OneMemoDTO의 자식레코드(LineCommentDTO)를 담을 컬렉션 타입 ofType : 자식의 DTO타입아래 collection태그 사용시현재 매퍼파일에서 메모글 하나 가져올때 반드시 resultMap="memoDtoResult"을 사용하지 -->
</resultMap>
   
   <select id="userList" parameterType="Map" resultMap="chatDtoResult">
      SELECT nickname,profile_img FROM members where userno=#{userno}
   </select>
   <insert id="createChatRoomno" parameterType="Map">
         INSERT INTO CHATROOM VALUES(SEQ_AUCTION_CHATROOM_NO.NEXTVAL,#{auction_no},#{product_no},#{town_no},#{wirteuserno},#{userno}, #{chatcontent},SYSDATE)
   </insert>
   <select id="findChatRoom" parameterType="Map" resultMap="chatDtoResult">
         SELECT c.*,m.nickname sendusernickname, mb.nickname writeusernickname, m.profile_img senduserprofileimg, mb.profile_img writeuserprofileimg from CHATROOM c JOIN members m on c.wirteuserno = m.userno JOIN members mb on c.userno = mb.userno where (c.userno=#{userno} or wirteuserno= #{userno}) and auction_no=#{auction_no} and product_no=#{product_no} and town_no=#{town_no}
   </select>
   <insert id="insertChatMessage" parameterType="Map">
         INSERT INTO CHATMESSAGE VALUES(#{roomno},#{senduserno},#{unread_count},#{chatcontent},SYSDATE)
   </insert>
   <select id="viewChatMessage" parameterType="Map" resultMap="chatDtoResult">
         SELECT * from CHATMESSAGE where room_no=#{roomno}
   </select>
   
   <select id="chatlist" parameterType="Map" resultMap="chatDtoResult">
         SELECT c.*,m.nickname sendusernickname ,mb.nickname writeusernickname, m.profile_img senduserprofileimg, mb.profile_img writeuserprofileimg from CHATROOM c JOIN members m on c.userno = m.userno JOIN members mb on c.wirteuserno = mb.userno where (c.userno=#{userno} or c.wirteuserno= #{userno}) 
   </select>
   <update id="updateChatRoomno" parameterType="Map">
         UPDATE CHATROOM SET chatcontent=#{chatcontent},  sendtime=SYSDATE WHERE room_no = #{roomno}
   </update>
   <select id="findnickname" parameterType="Map" resultMap="chatDtoResult">
         SELECT m.nickname sendusernickname, mb.nickname writeusernickname from CHATROOM c JOIN members m on c.wirteuserno = m.userno JOIN members mb on c.userno = mb.userno where room_no=#{roomno}
   </select>
</mapper>